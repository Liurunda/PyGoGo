<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ­Œè¯å¡«ç©ºæŒ‘æˆ˜</title>
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; }
        body { font-family: 'PingFang SC', sans-serif; background: #f4f7f6; display: flex; justify-content: center; padding: 40px; }
        .card { background: white; width: 100%; max-width: 600px; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* æ–°å¢ï¼šé”™è¯¯æ—¶çš„æ‘‡æ™ƒåŠ¨ç”» */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        /* åŠ è½½åŠ¨ç”» */
        #loader { text-align: center; padding: 50px 0; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* å†…å®¹æ ·å¼ */
        #quiz-container { display: none; }
        .quiz-text { font-size: 1.2rem; line-height: 1.8; background: #fff9f9; padding: 20px; border-left: 5px solid var(--accent); margin-bottom: 25px; white-space: pre-wrap; }
        .option-btn { display: block; width: 100%; padding: 12px 20px; margin: 10px 0; border: 2px solid #eee; border-radius: 8px; background: white; text-align: left; cursor: pointer; transition: 0.2s; font-size: 1rem; }
        .option-btn:hover:not(:disabled) { border-color: var(--accent); background: #fff5f5; }
        .option-btn.correct { background: #d4edda !important; border-color: #28a745 !important; color: #155724; }
        /* .option-btn.wrong { background: #f8d7da !important; border-color: #dc3545 !important; color: #721c24; } */
        .option-btn:disabled { cursor: default; }
        /* ä¿®æ”¹ï¼šé”™è¯¯é€‰é¡¹çš„æ ·å¼å˜å¾—æ›´æŸ”å’Œï¼Œå¹¶å¸¦æœ‰åˆ é™¤çº¿ */
        .option-btn.wrong { 
            background: #f1f2f6 !important; /* å˜æˆç°è‰²è€Œä¸æ˜¯é²œçº¢ */
            border-color: #ced4da !important; 
            color: #adb5bd; /* æ–‡å­—å˜æ·¡ */
            text-decoration: line-through; /*ä»¥æ­¤è¡¨ç¤ºæ’é™¤ */
            cursor: not-allowed;
            animation: shake 0.4s ease-in-out; /* è§¦å‘æ‘‡æ™ƒ */
        }
        #result-box { margin-top: 20px; padding: 20px; border-radius: 8px; display: none; }
        .explanation { color: #666; font-size: 0.95rem; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        
        .next-btn { 
            margin-top: 15px; padding: 10px 25px; background: var(--primary); color: white; 
            border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;
        }
        .next-btn:hover { opacity: 0.9; }
            
            /* é®ç½©å±‚ */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.6); z-index: 1000;
        display: flex; justify-content: center; align-items: center;
        backdrop-filter: blur(5px); /* èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
    }

    /* å¼¹çª—å†…å®¹ */
    .modal-content {
        background: white; padding: 30px; border-radius: 20px;
        width: 85%; max-width: 400px; text-align: center;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
        from { opacity: 0; transform: scale(0.8); }
        to { opacity: 1; transform: scale(1); }
    }

    .tutorial-steps { text-align: left; padding-left: 20px; margin: 20px 0; color: #555; }
    .tutorial-steps li { margin-bottom: 10px; line-height: 1.6; }

    .start-btn {
        background: var(--accent); color: white; border: none;
        padding: 12px 30px; border-radius: 25px; font-size: 1.1rem;
        cursor: pointer; transition: transform 0.2s;
        box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
    }
    .start-btn:hover { transform: scale(1.05); }

    /* å³ä¸‹è§’å¸®åŠ©å°å›¾æ ‡ */
    .help-icon {
        position: fixed; bottom: 20px; right: 20px;
        width: 40px; height: 40px; background: white;
        border-radius: 50%; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        display: flex; justify-content: center; align-items: center;
        font-weight: bold; color: var(--primary); cursor: pointer;
        z-index: 900; transition: 0.3s;
    }
    .help-icon:hover { transform: translateY(-3px); }

        
    </style>
</head>
<body>

<!-- æ–°æ‰‹å¼•å¯¼å¼¹çª— -->
<div id="tutorial-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3>ğŸµ æ¬¢è¿æ¥åˆ°æ­Œè¯æŒ‘æˆ˜ï¼</h3>
        <ul class="tutorial-steps">
            <li>ğŸ‘€ <strong>çœ‹æ­Œè¯ï¼š</strong> é˜…è¯»å±å¹•ä¸Šæ˜¾ç¤ºçš„æ­Œè¯ç‰‡æ®µã€‚</li>
            <li>ğŸ§  <strong>çŒœç©ºç¼ºï¼š</strong> çŒœçŒœåˆ’çº¿éƒ¨åˆ† <u>_____</u> æ˜¯ä»€ä¹ˆè¯ã€‚</li>
            <li>point_up_2: <strong>åšé€‰æ‹©ï¼š</strong> ç‚¹å‡»ä¸‹æ–¹é€‰é¡¹ã€‚é€‰é”™äº†ä¹Ÿæ²¡å…³ç³»ï¼Œå¯ä»¥æ’é™¤é”™è¯¯é€‰é¡¹é‡è¯•ï¼</li>
        </ul>
        <button class="start-btn" onclick="closeTutorial()">å¼€å§‹æŒ‘æˆ˜ ğŸš€</button>
    </div>
</div>

<!-- é¡µé¢è§’è½åŠ ä¸€ä¸ªå¸®åŠ©æŒ‰é’®ï¼Œéšæ—¶å¯ä»¥å†æ¬¡æŸ¥çœ‹ -->
<div class="help-icon" onclick="openTutorial()">?</div>


<div class="card">
    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loader">
        <div class="spinner"></div>
        <p id="loader-text">é¢˜ç›®åŠ è½½ä¸­...</p>
    </div>

    <!-- é¢˜ç›®å†…å®¹ -->
    <div id="quiz-container">
        <h2 id="song-title" style="color: var(--primary); margin-top: 0;"></h2>
        <div class="quiz-text" id="quiz-content"></div>
        <div id="options-group"></div>

        <div id="result-box">
            <h3 id="result-status"></h3>
            <div class="explanation" id="explanation"></div>
            <!-- ä¿®æ”¹äº†è¿™é‡Œçš„æŒ‰é’®è¡Œä¸º -->
            <button class="next-btn" onclick="showNextQuiz()">ä¸‹ä¸€é¢˜</button>
        </div>
    </div>
</div>

<script>
    let currentAnswer = "";
    let answered = false;
    let prefetchedData = null; 
    let isPrefetching = false; 

    // è¾…åŠ©å‡½æ•°ï¼šç­‰å¾…ä¸€æ®µæ—¶é—´
    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    /**
     * æ ¸å¿ƒå‡½æ•°ï¼šä» API è·å–é¢˜ç›®ï¼ˆå¸¦é‡è¯•é€»è¾‘ï¼‰
     * @param {number} maxRetries æœ€å¤§é‡è¯•æ¬¡æ•°
     */
    async function fetchQuizData(maxRetries = 3) {
        const loaderText = document.getElementById('loader-text');
        
        for (let i = 0; i <= maxRetries; i++) {
            try {
                const response = await fetch('/api/generate');
                
                // å¦‚æœæˆåŠŸï¼Œç›´æ¥è¿”å›æ•°æ®
                if (response.ok) {
                    return await response.json();
                }

                // å¦‚æœæ˜¯æœåŠ¡å™¨è¿‡è½½ (503) æˆ–è¯·æ±‚è¿‡å¤š (429)
                if (response.status === 503 || response.status === 429) {
                    if (i < maxRetries) {
                        const waitTime = (i + 1) * 2000; // é€’å¢ç­‰å¾…æ—¶é—´ï¼š2s, 4s, 6s
                        if (loaderText) loaderText.innerText = `æœåŠ¡å™¨å¤ªå¿™äº†ï¼Œæ­£åœ¨è¿›è¡Œç¬¬ ${i + 1} æ¬¡é‡è¯•...`;
                        await sleep(waitTime);
                        continue; // ç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯é‡è¯•
                    }
                }
                
                throw new Error(`è¯·æ±‚å¤±è´¥ (çŠ¶æ€ç : ${response.status})`);

            } catch (error) {
                console.error(`ç¬¬ ${i} æ¬¡å°è¯•å¤±è´¥:`, error);
                
                // æœ€åä¸€æ¬¡å°è¯•ä¹Ÿå¤±è´¥äº†
                if (i === maxRetries) {
                    return null;
                }
                
                // ç½‘ç»œæ–­å¼€ç­‰å¼‚å¸¸æƒ…å†µï¼Œç­‰å¾…åé‡è¯•
                const waitTime = (i + 1) * 2000;
                if (loaderText) loaderText.innerText = `ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œ${waitTime/1000}ç§’åé‡è¯•...`;
                await sleep(waitTime);
            }
        }
        return null;
    }

    // å°†æ•°æ®æ¸²æŸ“åˆ°é¡µé¢ä¸Š
    function renderQuiz(data) {
        const loader = document.getElementById('loader');
        const container = document.getElementById('quiz-container');

        if (!data) {
            // å¦‚æœæœ€ç»ˆè¿˜æ˜¯å¤±è´¥ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨é‡è¯•æŒ‰é’®
            loader.innerHTML = `
                <p style="color: #e74c3c;">âš ï¸ æš‚æ—¶æ— æ³•è·å–é¢˜ç›®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚</p>
                <button class="next-btn" onclick="location.reload()">æ‰‹åŠ¨åˆ·æ–°é¡µé¢</button>
            `;
            return;
        }

        // 1. é‡ç½®çŠ¶æ€
        answered = false;
        currentAnswer = data.answer;
        document.getElementById('result-box').style.display = 'none';
        const optionsGroup = document.getElementById('options-group');
        optionsGroup.innerHTML = ''; 

        // 2. å¡«å……æ–°å†…å®¹
        document.getElementById('song-title').innerText = `æ­Œæ›²ï¼š${data.song_name}`;
        document.getElementById('quiz-content').innerText = data.quiz_content;

        Object.entries(data.options).forEach(([key, value]) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerHTML = `<strong>${key}.</strong> ${value}`;
            btn.onclick = () => checkAnswer(key, btn, data.explanation);
            optionsGroup.appendChild(btn);
        });

        // 3. æ˜¾ç¤º UI
        loader.style.display = 'none';
        container.style.display = 'block';

        // 4. åå°é¢„å–ä¸‹ä¸€é¢˜
        prefetchNext();
    }

    // åå°é¢„å–ä¸‹ä¸€é¢˜
    async function prefetchNext() {
        if (isPrefetching) return;
        isPrefetching = true;
        // é¢„å–æ—¶ä¹Ÿä½¿ç”¨å¸¦é‡è¯•çš„å‡½æ•°
        prefetchedData = await fetchQuizData(2); 
        isPrefetching = false;
    }

    // ç”¨æˆ·ç‚¹å‡»â€œä¸‹ä¸€é¢˜â€
    async function showNextQuiz() {
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const container = document.getElementById('quiz-container');

        if (!prefetchedData) {
            container.style.display = 'none';
            loader.style.display = 'block';
            loaderText.innerText = "æ­£åœ¨æ‹¼å‘½åŠ è½½ä¸‹ä¸€é¢˜...";
            
            // å¦‚æœå½“å‰æ²¡æœ‰é¢„å–æˆåŠŸçš„æ•°æ®ï¼Œé‡æ–°å‘èµ·ä¸€æ¬¡è·å–è¯·æ±‚
            const data = await fetchQuizData(3);
            if (data) {
                renderQuiz(data);
            } else {
                renderQuiz(null); // å¤„ç†å½»åº•å¤±è´¥çš„æƒ…å†µ
            }
        } else {
            const data = prefetchedData;
            prefetchedData = null; 
            renderQuiz(data);
        }
    }

    let wrongAttempts = 0; 

    function checkAnswer(choice, btn, explanation) {
        // å¦‚æœå·²ç»ç­”å¯¹å¹¶é”å®šäº†ï¼Œå°±ä¸èƒ½å†ç‚¹äº†
        if (answered) return;

        const resultBox = document.getElementById('result-box');
        const status = document.getElementById('result-status');
        const explanationDiv = document.getElementById('explanation');

        if (choice === currentAnswer) {
            // --- ç­”å¯¹äº† ---
            answered = true; // é”å®šçŠ¶æ€
            btn.classList.add('correct');
            
            // é”å®šæ‰€æœ‰å…¶ä»–æŒ‰é’®
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(b => b.disabled = true);

            // æ ¹æ®å°è¯•æ¬¡æ•°ç»™äºˆä¸åŒçš„é¼“åŠ±æ–‡æ¡ˆ
            if (wrongAttempts === 0) {
                status.innerText = "ğŸ‰ å¤ªæ£’äº†ï¼ä¸€å‡»å³ä¸­ï¼";
                status.style.color = "#28a745";
            } else {
                status.innerText = "âœ… ç­”å¯¹å•¦ï¼";
                status.style.color = "#28a745";
            }

            // æ˜¾ç¤ºè§£æåŒºåŸŸ
            explanationDiv.innerText = "è§£æï¼š" + explanation;
            explanationDiv.style.display = "block"; // ç¡®ä¿è§£æå¯è§
            resultBox.style.display = 'block';
            resultBox.style.background = '#f0fff4';
            
            // é‡ç½®é”™è¯¯è®¡æ•°ä»¥ä¾¿ä¸‹ä¸€é¢˜ä½¿ç”¨
            wrongAttempts = 0; 

        } else {
            // --- ç­”é”™äº† ---
            wrongAttempts++;
            
            // 1. è§†è§‰åé¦ˆï¼šå˜ç°ã€æ‘‡æ™ƒ
            btn.classList.add('wrong');
            
            // 2. é€»è¾‘åé¦ˆï¼šåªç¦ç”¨è¿™ä¸€ä¸ªæŒ‰é’®ï¼Œè®©ç”¨æˆ·ç»§ç»­é€‰
            btn.disabled = true;

            // 3. æŸ”å’Œçš„æç¤ºæ–‡æ¡ˆ
            status.innerText = getRandomEncouragement(); 
            status.style.color = "#888"; // ä½¿ç”¨ä¸­æ€§é¢œè‰²ï¼Œä¸è¦ç”¨è­¦å‘Šçº¢
            
            // 4. æš‚æ—¶ä¸æ˜¾ç¤ºè§£æï¼Œåªæ˜¾ç¤ºæç¤ºæ¡†
            explanationDiv.style.display = "none"; // éšè—è§£æï¼Œé¿å…å‰§é€
            resultBox.style.display = 'block';
            resultBox.style.background = '#fff'; // ä¿æŒç™½è‰²æˆ–å¾ˆæ·¡çš„ç°è‰²
        }
    }

    // è¾…åŠ©å‡½æ•°ï¼šéšæœºé¼“åŠ±æ–‡æ¡ˆ
    function getRandomEncouragement() {
        const messages = [
            "ğŸ¤” å¥½åƒä¸å¤ªå¯¹ï¼Œæ¢ä¸€ä¸ªè¯•è¯•ï¼Ÿ",
            "ğŸ‘» è¿™æ˜¯ä¸€ä¸ªå¹²æ‰°é¡¹ï¼Œå†é€‰é€‰çœ‹ï¼",
            "ğŸ’ª åˆ«æ°”é¦ï¼Œç­”æ¡ˆå°±åœ¨å‰©ä¸‹çš„é€‰é¡¹é‡Œï¼",
            "ğŸ™Š å·®ç‚¹å°±å¯¹äº†ï¼Œæ’é™¤ä¸€ä¸ªé”™è¯¯ç­”æ¡ˆã€‚"
        ];
        return messages[Math.floor(Math.random() * messages.length)];
    }

    function checkTutorial() {
    const hasSeen = localStorage.getItem('lyric_quiz_tutorial_seen');
    if (!hasSeen) {
        document.getElementById('tutorial-modal').style.display = 'flex';
    }
}

    function closeTutorial() {
        document.getElementById('tutorial-modal').style.display = 'none';
        localStorage.setItem('lyric_quiz_tutorial_seen', 'true'); // æ ‡è®°å·²è¯»
    }

    function openTutorial() {
        document.getElementById('tutorial-modal').style.display = 'flex';
    }

    // åœ¨ window.onload ä¸­è°ƒç”¨
    window.onload = async () => {
        checkTutorial(); // å…ˆæ£€æŸ¥å¼•å¯¼
        const firstQuiz = await fetchQuizData(3);
        renderQuiz(firstQuiz);
    };
</script>

</body>
</html>